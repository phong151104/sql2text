catalog: lakehouse
schema: lh_vnfilm_v2
table_name: orders
domain: vnfilm_ticketing

table_type: fact
business_name: "Bảng giao dịch đơn hàng (orders)"
grain: "1 dòng = 1 giao dịch/đơn hàng (thanh toán) liên quan VNPAY/vendor/promotion/billing"

description: >
  Bảng giao dịch đơn hàng: chứa trạng thái, thông tin kênh/định danh ngân hàng,
  số lượng (ghế, bắp nước), các khoản tiền theo vendor/VNPAY/promotion/billing,
  và các mốc thời gian của promotion & billing.

tags:
  - fact_table
  - transaction
  - payment
  - vnfilm
  - vnpay

primary_key:
  - id

foreign_keys:
  - column: bank_id
    references_table: "lakehouse.lh_vnfilm_v2.bank"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng bank để lấy thông tin ngân hàng."

  - column: campaign_id
    references_table: "lakehouse.lh_vnfilm_v2.campaign"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng campaign để phân tích hiệu quả chiến dịch."

  - column: sub_campaign_id
    references_table: "lakehouse.lh_vnfilm_v2.sub_campaign"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng sub_campaign (nhánh chi tiết của campaign)."

time_columns:
  - expire_date
  - billing_date
  - created_date
  - modified_date
  - issued_date
  - promotion_hold_date
  - promotion_release_date
  - promotion_last_timeout_date
  - promotion_commit_date

recommended_filters:
  - "created_date (hoặc billing_date/issued_date) cho lọc theo thời gian"
  - "status, issue_status, billing_status cho trạng thái giao dịch"
  - "bank_identity_hash hoặc created_by_hash cho lọc theo người dùng (áp RLS nếu cần)"

concepts:
  - name: seat
    synonyms: ["ghế", "vé", "seat"]

  - name: concession
    synonyms: ["bắp", "nước", "combo", "concession"]

  - name: vendor
    synonyms: ["nhà cung cấp", "đối tác", "rạp", "merchant", "vendor"]

  - name: vnpay
    synonyms: ["VNPAY", "ví", "cổng thanh toán"]

  - name: promotion
    synonyms: ["khuyến mại", "khuyến mãi", "voucher", "mã giảm giá", "promotion"]

  - name: billing
    synonyms: ["đối soát", "hóa đơn", "billing"]

columns:
  id:
    data_type: bigint
    business_name: "ID đơn/giao dịch"
    description: "Định danh duy nhất cho mỗi đơn/giao dịch."
    semantics: [id, primary, transaction]
    pii: false

  pay_code:
    data_type: varchar
    description: "Mã hình thức/luồng thanh toán (code)."
    semantics: [payment_method]

  status:
    data_type: varchar
    description: "Trạng thái tổng của đơn/giao dịch."
    semantics: [status, transaction_status]

  issue_status:
    data_type: varchar
    description: "Trạng thái phát hành/ghi nhận (issue)."
    semantics: [status, issue]

  expire_date:
    data_type: timestamp(6)
    description: "Thời điểm hết hạn (expiry) của đơn/giao dịch."
    semantics: [date, expire_time]

  bank_id:
    data_type: bigint
    description: "ID ngân hàng (mapping sang bảng bank)."
    semantics: [id, bank]
    pii: false

  vendor_seat_original_amount:
    data_type: decimal(38,18)
    description: "Vendor - ghế: giá gốc."
    semantics: [amount, money, seat, vendor]
    unit: VND

  vendor_seat_charge_amount:
    data_type: decimal(38,18)
    description: "Vendor - ghế: phí/charge."
    semantics: [amount, money, seat, vendor, fee]
    unit: VND

  vendor_seat_discount_amount:
    data_type: decimal(38,18)
    description: "Vendor - ghế: giảm giá."
    semantics: [amount, money, seat, vendor, discount]
    unit: VND

  vendor_seat_sub_amount:
    data_type: decimal(38,18)
    description: "Vendor - ghế: tạm tính/sub."
    semantics: [amount, money, seat, vendor, subtotal]
    unit: VND

  vendor_seat_reconciliation_amount:
    data_type: decimal(38,18)
    description: "Vendor - ghế: số tiền đối soát."
    semantics: [amount, money, seat, vendor, reconciliation]
    unit: VND

  vendor_con_original_amount:
    data_type: decimal(38,18)
    description: "Vendor - concession: giá gốc."
    semantics: [amount, money, concession, vendor]
    unit: VND

  vendor_con_charge_amount:
    data_type: decimal(38,18)
    description: "Vendor - concession: phí/charge."
    semantics: [amount, money, concession, vendor, fee]
    unit: VND

  vendor_con_discount_amount:
    data_type: decimal(38,18)
    description: "Vendor - concession: giảm giá."
    semantics: [amount, money, concession, vendor, discount]
    unit: VND

  vendor_con_sub_amount:
    data_type: decimal(38,18)
    description: "Vendor - concession: tạm tính/sub."
    semantics: [amount, money, concession, vendor, subtotal]
    unit: VND

  vendor_con_reconciliation_amount:
    data_type: decimal(38,18)
    description: "Vendor - concession: số tiền đối soát."
    semantics: [amount, money, concession, vendor, reconciliation]
    unit: VND

  vendor_total_original_amount:
    data_type: decimal(38,18)
    description: "Vendor - tổng: giá gốc."
    semantics: [amount, money, vendor, total, gross]
    unit: VND

  vendor_total_charge_amount:
    data_type: decimal(38,18)
    description: "Vendor - tổng: phí/charge."
    semantics: [amount, money, vendor, total, fee]
    unit: VND

  vendor_total_discount_amount:
    data_type: decimal(38,18)
    description: "Vendor - tổng: giảm giá."
    semantics: [amount, money, vendor, total, discount]
    unit: VND

  vendor_other_sub_amount:
    data_type: decimal(38,18)
    description: "Vendor - khác: tạm tính/sub."
    semantics: [amount, money, vendor, subtotal, other]
    unit: VND

  vendor_total_sub_amount:
    data_type: decimal(38,18)
    description: "Vendor - tổng: tạm tính/sub."
    semantics: [amount, money, vendor, subtotal, total]
    unit: VND

  vendor_total_reconciliation_amount:
    data_type: decimal(38,18)
    description: "Vendor - tổng: số tiền đối soát."
    semantics: [amount, money, vendor, reconciliation, total]
    unit: VND

  vnpay_seat_amount:
    data_type: decimal(38,18)
    description: "VNPAY - ghế: amount."
    semantics: [amount, money, vnpay, seat]
    unit: VND

  vnpay_concession_amount:
    data_type: decimal(38,18)
    description: "VNPAY - concession: amount."
    semantics: [amount, money, vnpay, concession]
    unit: VND

  vnpay_total_amount:
    data_type: decimal(38,18)
    description: "VNPAY - tổng: amount."
    semantics: [amount, money, vnpay, total]
    unit: VND

  vnpay_final_amount:
    data_type: decimal(38,18)
    description: "VNPAY - cuối cùng: amount sau điều chỉnh."
    semantics: [amount, money, vnpay, final]
    unit: VND

  promotion_id:
    data_type: varchar
    description: "ID khuyến mại/voucher."
    semantics: [id, promotion]

  promotion_code:
    data_type: varchar
    description: "Mã khuyến mại/voucher."
    semantics: [code, promotion]

  promotion_amount:
    data_type: decimal(38,18)
    description: "Tổng tiền khuyến mại."
    semantics: [amount, money, promotion, total]
    unit: VND

  promotion_vnpay_amount:
    data_type: decimal(38,18)
    description: "Khuyến mại do VNPAY chịu."
    semantics: [amount, money, promotion, vnpay]
    unit: VND

  promotion_vendor_amount:
    data_type: decimal(38,18)
    description: "Khuyến mại do Vendor chịu."
    semantics: [amount, money, promotion, vendor]
    unit: VND

  promotion_bank_amount:
    data_type: decimal(38,18)
    description: "Khuyến mại do Bank chịu."
    semantics: [amount, money, promotion, bank]
    unit: VND

  promotion_status:
    data_type: varchar
    description: "Trạng thái xử lý promotion."
    semantics: [status, promotion]

  promotion_hold_response:
    data_type: varchar
    description: "Response khi hold promotion."

  promotion_hold_date:
    data_type: timestamp(6)
    description: "Thời điểm hold promotion."
    semantics: [date, promotion, hold_time]

  promotion_release_response:
    data_type: varchar
    description: "Response khi release promotion."

  promotion_release_date:
    data_type: timestamp(6)
    description: "Thời điểm release promotion."
    semantics: [date, promotion, release_time]

  promotion_last_timeout_response:
    data_type: varchar
    description: "Response timeout gần nhất promotion."

  promotion_last_timeout_date:
    data_type: timestamp(6)
    description: "Thời điểm timeout gần nhất promotion."
    semantics: [date, promotion, timeout_time]

  promotion_commit_response:
    data_type: varchar
    description: "Response khi commit promotion."

  promotion_commit_date:
    data_type: timestamp(6)
    description: "Thời điểm commit promotion."
    semantics: [date, promotion, commit_time]

  promotion_reconciliation_code:
    data_type: varchar
    description: "Mã đối soát promotion."

  billing_id:
    data_type: varchar
    description: "ID billing/đối soát."
    semantics: [id, billing]

  billing_amount:
    data_type: decimal(38,18)
    description: "Số tiền billing."
    semantics: [amount, money, billing]
    unit: VND

  billing_date:
    data_type: timestamp(6)
    description: "Thời điểm billing."
    semantics: [date, billing_time]

  billing_status:
    data_type: varchar
    description: "Trạng thái billing."
    semantics: [status, billing]

  billing_sub_fee:
    data_type: decimal(38,18)
    description: "Phí billing (sub fee)."
    semantics: [amount, fee, billing]
    unit: VND

  billing_discount_fee:
    data_type: decimal(38,18)
    description: "Phí billing giảm/chiết khấu."
    semantics: [amount, fee, discount, billing]
    unit: VND

  billing_data:
    data_type: varchar
    description: "Payload/metadata billing (raw/text)."

  billing_pay_source:
    data_type: varchar
    description: "Nguồn thanh toán cho billing."

  vendor_trace_id:
    data_type: varchar
    description: "Trace ID phía vendor."

  vendor_trace_data:
    data_type: varchar
    description: "Dữ liệu trace phía vendor (raw/text)."

  vendor_booking_no:
    data_type: varchar
    description: "Mã booking phía vendor."

  vendor_booking_data:
    data_type: varchar
    description: "Dữ liệu booking phía vendor (raw/text)."

  source_booking:
    data_type: varchar
    description: "Nguồn booking (kênh/nguồn phát sinh)."

  number_of_seats:
    data_type: integer
    description: "Số lượng ghế/vé."
    semantics: [count, seat]

  number_of_concessions:
    data_type: integer
    description: "Số lượng concession (combo bắp nước)."
    semantics: [count, concession]

  campaign_id:
    data_type: bigint
    description: "ID campaign."
    semantics: [id, campaign]

  sub_campaign_id:
    data_type: bigint
    description: "ID sub-campaign."
    semantics: [id, campaign, sub_campaign]

  campaign_code:
    data_type: varchar
    description: "Mã campaign."
    semantics: [code, campaign]

  campaign_type:
    data_type: varchar
    description: "Loại campaign."

  issued_date:
    data_type: timestamp(6)
    description: "Thời điểm issue/ghi nhận phát hành."
    semantics: [date, issue_time]

  created_date:
    data_type: timestamp(6)
    description: "Thời điểm tạo bản ghi."
    semantics: [date, created_time]

  modified_date:
    data_type: timestamp(6)
    description: "Thời điểm cập nhật bản ghi."
    semantics: [date, modified_time]

  modified_by:
    data_type: varchar
    description: "User/service cập nhật."

  vnpay_seat_profit:
    data_type: decimal(38,18)
    description: "Lợi nhuận VNPAY phần ghế."
    semantics: [amount, profit, vnpay, seat]
    unit: VND

  vnpay_concession_profit:
    data_type: decimal(38,18)
    description: "Lợi nhuận VNPAY phần concession."
    semantics: [amount, profit, vnpay, concession]
    unit: VND

  vendor_seat_fee:
    data_type: decimal(38,18)
    description: "Phí vendor phần ghế."
    semantics: [amount, fee, vendor, seat]
    unit: VND

  vnpay_seat_fee:
    data_type: decimal(38,18)
    description: "Phí VNPAY phần ghế."
    semantics: [amount, fee, vnpay, seat]
    unit: VND

  bank_channel_id:
    data_type: varchar
    description: "Kênh ngân hàng (channel id)."

  bank_identity:
    data_type: varchar
    description: "Định danh ngân hàng (raw)."
    semantics: [user_identity, bank, raw]
    pii: true
    sensitive: true

  bank_identity_hash:
    data_type: varchar
    description: "Định danh ngân hàng (hash) - thường dùng join/RLS."
    semantics: [user_identity, bank, hash]
    pii: false
    sensitive: true

  created_by:
    data_type: varchar
    description: "Người tạo (raw)."
    semantics: [user_identity, creator, raw]
    pii: true
    sensitive: true

  created_by_hash:
    data_type: varchar
    description: "Người tạo (hash)."
    semantics: [user_identity, creator, hash]
    pii: false
    sensitive: true

guardrails:
  sql:
    read_only: true
    require_limit: true
    default_limit: 200
    forbid_select_star: true
    preferred_time_filter: "created_date"
    allowed_time_columns:
      - created_date
      - billing_date
      - issued_date
    forbidden_columns:
      - bank_identity
      - created_by

sample_questions:
  - "Tổng doanh thu VNPAY theo tháng trong 6 tháng gần nhất là bao nhiêu?"
  - "Số lượng vé (số ghế) bán ra theo từng rạp và campaign trong quý 1 2025?"
  - "Tỉ lệ đơn bị fail issue hoặc billing theo kênh ngân hàng là bao nhiêu?"
  - "Tổng số tiền promotion do VNPAY chịu trong tháng 3 2025?"
  - "Lợi nhuận VNPAY phần ghế theo từng ngân hàng trong năm 2024?"

sample_queries:
  - description: "Doanh thu VNPAY theo tháng (6 tháng gần nhất)"
    sql: |
      SELECT
        date_trunc('month', created_date) AS month,
        SUM(vnpay_total_amount) AS total_vnpay_amount
      FROM lakehouse.lh_vnfilm_v2.orders
      WHERE created_date >= date_trunc('month', current_date) - interval '5 month'
      GROUP BY 1
      ORDER BY 1;

  - description: "Số lượng ghế bán ra theo campaign trong một khoảng thời gian"
    sql: |
      SELECT
        campaign_id,
        campaign_code,
        SUM(number_of_seats) AS total_seats
      FROM lakehouse.lh_vnfilm_v2.orders
      WHERE created_date BETWEEN DATE '2025-01-01' AND DATE '2025-03-31'
      GROUP BY 1, 2;

  - description: "Tỉ lệ billing fail theo kênh ngân hàng"
    sql: |
      SELECT
        bank_channel_id,
        COUNT(*) AS total_orders,
        SUM(CASE WHEN billing_status != 'SUCCESS' THEN 1 ELSE 0 END) AS failed_orders,
        SUM(CASE WHEN billing_status != 'SUCCESS' THEN 1 ELSE 0 END)::decimal
          / NULLIF(COUNT(*), 0) AS failed_ratio
      FROM lakehouse.lh_vnfilm_v2.orders
      WHERE created_date >= DATE '2024-01-01'
      GROUP BY 1
      ORDER BY failed_ratio DESC;
